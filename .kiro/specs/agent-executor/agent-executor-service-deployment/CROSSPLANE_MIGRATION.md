# Crossplane Migration Summary

## Overview

This document summarizes the architectural shift from manual secret management to Crossplane-based database provisioning for the agent-executor service.

## What Changed

### Before (Manual Approach)
- Database credentials stored in AWS SSM Parameter Store
- ExternalSecrets Operator (ESO) synced credentials from SSM to Kubernetes
- Manual credential generation and rotation
- Credentials touched by humans and stored in multiple places

### After (Crossplane Approach)
- Databases provisioned via Crossplane claims
- Credentials auto-generated by Crossplane
- `writeConnectionSecretToRef` creates secrets directly in service namespace
- Zero-touch: no human interaction with credentials
- No database credentials in AWS SSM

## Files Created

### Crossplane Claims
1. `bizmatters/services/agent_executor/platform/claims/intelligence-deepagents/postgres-claim.yaml`
   - PostgresInstance claim for agent-executor-db
   - Generates `agent-executor-postgres` secret

2. `bizmatters/services/agent_executor/platform/claims/intelligence-deepagents/dragonfly-claim.yaml`
   - DragonflyInstance claim for agent-executor-cache
   - Generates `agent-executor-dragonfly` secret

### Platform Infrastructure Updates
3. `zerotouch-platform/platform/05-databases/definitions/postgres-xrd.yaml`
   - Added `connectionSecretKeys` to XRD

4. `zerotouch-platform/platform/05-databases/definitions/dragonfly-xrd.yaml`
   - Added `connectionSecretKeys` to XRD

5. `zerotouch-platform/platform/05-databases/compositions/postgres-composition.yaml`
   - Added `publishConnectionDetailsTo` section
   - Added `connectionDetails` to secret resource
   - Secrets now include: endpoint, port, username, password, database

6. `zerotouch-platform/platform/05-databases/compositions/dragonfly-composition.yaml`
   - Added `publishConnectionDetailsTo` section
   - Added `connectionDetails` to secret resource
   - Secrets now include: endpoint, port, password

### ESO for Non-Database Secrets
7. `bizmatters/services/agent_executor/platform/claims/intelligence-deepagents/external-secrets/image-pull-secret-es.yaml`
   - NEW: ESO-based ImagePullSecret (replaces manual kubectl approach)
   - Reads GitHub credentials from AWS SSM
   - Formats as kubernetes.io/dockerconfigjson

8. `bizmatters/services/agent_executor/platform/claims/intelligence-deepagents/external-secrets/llm-keys-es.yaml`
   - UNCHANGED: Still uses ESO for LLM API keys

## Files Deleted

1. `bizmatters/services/agent_executor/platform/claims/intelligence-deepagents/external-secrets/postgres-es.yaml`
   - REMOVED: No longer needed (Crossplane manages)

2. `bizmatters/services/agent_executor/platform/claims/intelligence-deepagents/external-secrets/dragonfly-es.yaml`
   - REMOVED: No longer needed (Crossplane manages)

## Files Updated

### Deployment Manifest
- `bizmatters/services/agent_executor/platform/claims/intelligence-deepagents/agent-executor-deployment.yaml`
  - Updated secret key references:
    - `POSTGRES_HOST` → reads from key `endpoint`
    - `POSTGRES_PORT` → reads from key `port`
    - `POSTGRES_DB` → reads from key `database`
    - `POSTGRES_USER` → reads from key `username`
    - `POSTGRES_PASSWORD` → reads from key `password`
    - `DRAGONFLY_HOST` → reads from key `endpoint`
    - `DRAGONFLY_PORT` → reads from key `port`
    - `DRAGONFLY_PASSWORD` → reads from key `password`

### Configuration Templates
- `zerotouch-platform/.env.ssm.example`
  - REMOVED: PostgreSQL and Dragonfly credential sections
  - ADDED: GitHub registry credentials section
  - ADDED: Note that database credentials are managed by Crossplane

### Documentation
- `zerotouch-platform/.kiro/specs/agent-executor/agent-executor-service-deployment/requirements.md`
  - Updated Requirement 11: Now covers Crossplane claims
  - Added Requirement 11b: ESO for LLM keys and registry credentials
  - Updated Requirement 14: ImagePullSecret via ESO
  - Updated Requirement 18: Removed database credentials from SSM

- `zerotouch-platform/.kiro/specs/agent-executor/agent-executor-service-deployment/design.md`
  - Updated section 2.5: Database Per Service Pattern with Crossplane details
  - Updated section 3.3: Deployment configuration with Crossplane claims
  - Updated section 4.1: Initial setup without database credentials in SSM

- `zerotouch-platform/.kiro/specs/agent-executor/agent-executor-service-deployment/tasks.md`
  - Updated task 3.1: Removed database credentials from SSM configuration
  - Updated task 3.4: ImagePullSecret via ESO instead of manual kubectl
  - Updated task 3.5: PostgreSQL Crossplane Claim (was ExternalSecret)
  - Updated task 3.6: Dragonfly Crossplane Claim (was ExternalSecret)

## Secret Key Mapping

### PostgreSQL Secret (`agent-executor-postgres`)
| Application Env Var | Secret Key | Source |
|---------------------|------------|--------|
| POSTGRES_HOST | endpoint | Crossplane |
| POSTGRES_PORT | port | Crossplane |
| POSTGRES_DB | database | Crossplane |
| POSTGRES_USER | username | Crossplane |
| POSTGRES_PASSWORD | password | Crossplane |

### Dragonfly Secret (`agent-executor-dragonfly`)
| Application Env Var | Secret Key | Source |
|---------------------|------------|--------|
| DRAGONFLY_HOST | endpoint | Crossplane |
| DRAGONFLY_PORT | port | Crossplane |
| DRAGONFLY_PASSWORD | password | Crossplane |

### LLM Keys Secret (`agent-executor-llm-keys`)
| Application Env Var | Secret Key | Source |
|---------------------|------------|--------|
| OPENAI_API_KEY | OPENAI_API_KEY | ESO → AWS SSM |
| ANTHROPIC_API_KEY | ANTHROPIC_API_KEY | ESO → AWS SSM |

### ImagePullSecret (`ghcr-pull-secret`)
| Secret Key | Source |
|------------|--------|
| .dockerconfigjson | ESO → AWS SSM (formatted) |

## Benefits of This Approach

1. **Zero-Touch Security**: No human ever sees or handles database passwords
2. **GitOps Native**: Commit claim YAML, infrastructure provisions automatically
3. **Separation of Concerns**: 
   - Crossplane manages infrastructure secrets (databases)
   - ESO manages application secrets (API keys, registry)
4. **Credential Rotation**: Update claim, Crossplane regenerates credentials
5. **Multi-Tenant Ready**: Each service gets isolated database instances
6. **Audit Trail**: All changes via Git commits, no manual kubectl commands

## Migration Path

For existing deployments:

1. **Apply Crossplane XRD/Composition updates** (platform repo)
2. **Create Crossplane claims** (service repo)
3. **Wait for Crossplane to provision** databases and secrets
4. **Update deployment manifest** to use new secret keys
5. **Remove old ExternalSecrets** for databases
6. **Delete database credentials from AWS SSM** (optional cleanup)

## Verification

After migration, verify:

```bash
# Check Crossplane claims
kubectl get postgresinstance -n intelligence-deepagents
kubectl get dragonflyinstance -n intelligence-deepagents

# Check generated secrets
kubectl get secret agent-executor-postgres -n intelligence-deepagents -o yaml
kubectl get secret agent-executor-dragonfly -n intelligence-deepagents -o yaml

# Verify secret keys
kubectl get secret agent-executor-postgres -n intelligence-deepagents -o jsonpath='{.data}' | jq 'keys'
# Should show: ["database", "endpoint", "password", "port", "username"]

kubectl get secret agent-executor-dragonfly -n intelligence-deepagents -o jsonpath='{.data}' | jq 'keys'
# Should show: ["endpoint", "password", "port"]
```

## Rollback Plan

If issues arise:

1. Revert deployment manifest to use old secret keys
2. Recreate ExternalSecrets for databases
3. Ensure AWS SSM parameters still exist
4. Delete Crossplane claims (keeps databases running)
5. Investigate and fix Crossplane configuration
6. Re-attempt migration

## Future Enhancements

- Add database backup claims
- Add read replicas for PostgreSQL
- Add monitoring/alerting for database health
- Implement automated credential rotation policies
