# Design Document: Zero-Touch PostgreSQL Provisioning

## Overview

This design implements a zero-touch PostgreSQL database provisioning pattern using Crossplane and CloudNative-PG (CNPG). The system enables developers to provision databases with a minimal claim - just a name and `writeConnectionSecretToRef` - while the platform handles all credential generation and delivery automatically.

The key principle is **no human-known passwords**: CNPG auto-generates credentials, and Crossplane copies them to the application namespace. No SSM, no ExternalSecrets, no manual password management.

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Zero-Touch Flow                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Developer creates claim:                                                   │
│   ┌─────────────────────────────────────────┐                               │
│   │ kind: PostgresInstance                  │                               │
│   │ metadata:                               │                               │
│   │   name: agent-executor-db               │                               │
│   │   namespace: intelligence-deepagents    │                               │
│   │ spec:                                   │                               │
│   │   size: medium                          │                               │
│   │ writeConnectionSecretToRef:             │                               │
│   │   name: agent-executor-postgres         │                               │
│   │   namespace: intelligence-deepagents    │                               │
│   └─────────────────────────────────────────┘                               │
│                           │                                                  │
│                           ▼                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    Crossplane Composition                            │   │
│   │  1. Auto-derive names:                                               │   │
│   │     - database: agent_executor_db                                    │   │
│   │     - owner: agent_executor_db                                       │   │
│   │     - cluster: agent-executor-db                                     │   │
│   │  2. Create CNPG Cluster (no secret reference)                        │   │
│   │  3. Wait for CNPG to generate -app secret                            │   │
│   │  4. Copy credentials to writeConnectionSecretToRef                   │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                           │                                                  │
│           ┌───────────────┴───────────────┐                                 │
│           ▼                               ▼                                 │
│   ┌───────────────────┐           ┌───────────────────────────────┐        │
│   │ CNPG Cluster      │           │ Connection Secret              │        │
│   │ (same namespace)  │           │ (app namespace)                │        │
│   │                   │           │                                │        │
│   │ Creates:          │  ──────►  │ endpoint: cluster-rw.ns.svc    │        │
│   │ {name}-app secret │   copy    │ port: 5432                     │        │
│   │ with auto-gen pwd │           │ username: agent_executor_db    │        │
│   └───────────────────┘           │ password: <auto-generated>     │        │
│                                   │ database: agent_executor_db    │        │
│                                   └───────────────────────────────┘        │
│                                               │                             │
│                                               ▼                             │
│                                   ┌───────────────────────────────┐        │
│                                   │ Application Deployment         │        │
│                                   │ env:                           │        │
│                                   │   - name: POSTGRES_HOST        │        │
│                                   │     valueFrom:                 │        │
│                                   │       secretKeyRef:            │        │
│                                   │         name: agent-executor.. │        │
│                                   │         key: endpoint          │        │
│                                   └───────────────────────────────┘        │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Components and Interfaces

### 1. XRD (CompositeResourceDefinition)

**File:** `platform/05-databases/definitions/postgres-xrd.yaml`

The XRD defines a minimal API surface:

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `size` | enum | Yes | `small` | Instance size (small/medium/large) |
| `version` | string | No | `"16"` | PostgreSQL version |
| `storageGB` | integer | No | `20` | Storage size in GB |

**Removed fields** (auto-derived or eliminated):
- `databaseName` - auto-derived from claim name
- `databaseOwner` - auto-derived from claim name  
- `credentialsSecretName` - eliminated (CNPG auto-generates)
- `connectionSecretName` - replaced by `writeConnectionSecretToRef`

### 2. Composition

**File:** `platform/05-databases/compositions/postgres-composition.yaml`

The composition creates two resources:

#### Resource 1: CNPG Cluster
- Created in the **claim's namespace** (same namespace pattern)
- Bootstrap with `initdb` - **no secret reference** (triggers auto-generation)
- Database and owner auto-derived from claim name (hyphens → underscores)

#### Resource 2: Connection Secret (via Object provider)
- Uses Crossplane Object provider with `references` to copy from CNPG `-app` secret
- Target location from `writeConnectionSecretToRef`
- Adds computed `endpoint` field

### 3. Name Derivation Logic

| Claim Name | Database | Owner | Cluster | CNPG Secret |
|------------|----------|-------|---------|-------------|
| `agent-executor-db` | `agent_executor_db` | `agent_executor_db` | `agent-executor-db` | `agent-executor-db-app` |
| `my-service` | `my_service` | `my_service` | `my-service` | `my-service-app` |

**Transformation:** Replace `-` with `_` for PostgreSQL compatibility.

### 4. Connection Secret Format

The connection secret created in the app namespace contains:

| Key | Source | Example Value |
|-----|--------|---------------|
| `endpoint` | Computed | `agent-executor-db-rw.intelligence-deepagents.svc.cluster.local` |
| `port` | Static | `5432` |
| `username` | CNPG `-app` secret | `agent_executor_db` |
| `password` | CNPG `-app` secret | `<auto-generated>` |
| `database` | CNPG `-app` secret | `agent_executor_db` |

## Data Models

### PostgresInstance Claim

```yaml
apiVersion: database.bizmatters.io/v1alpha1
kind: PostgresInstance
metadata:
  name: <service-name>-db
  namespace: <app-namespace>
spec:
  size: small | medium | large
  version: "16"        # optional
  storageGB: 20        # optional
writeConnectionSecretToRef:
  name: <secret-name>
  namespace: <app-namespace>
```

### CNPG Cluster (Generated)

```yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: <claim-name>
  namespace: <claim-namespace>
spec:
  instances: 1
  bootstrap:
    initdb:
      database: <claim-name-with-underscores>
      owner: <claim-name-with-underscores>
      # NO secret reference - triggers auto-generation
  storage:
    size: <storageGB>Gi
```

### Connection Secret (Generated)

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: <writeConnectionSecretToRef.name>
  namespace: <writeConnectionSecretToRef.namespace>
type: Opaque
data:
  endpoint: <base64>
  port: <base64>
  username: <base64>
  password: <base64>
  database: <base64>
```

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*

### Property 1: Zero-Touch Credential Generation
*For any* PostgresInstance claim without a credentials secret reference, the resulting CNPG Cluster manifest SHALL NOT contain a `spec.bootstrap.initdb.secret` field, ensuring CNPG auto-generates credentials.
**Validates: Requirements 1.1, 4.1**

### Property 2: Credential Propagation
*For any* PostgresInstance claim with `writeConnectionSecretToRef`, when the CNPG cluster becomes ready, the target secret SHALL contain non-empty values for keys: `endpoint`, `port`, `username`, `password`, and `database`.
**Validates: Requirements 1.2, 2.1**

### Property 3: Name Auto-Derivation
*For any* claim name, the resulting database name and owner SHALL equal the claim name with all hyphens replaced by underscores.
**Validates: Requirements 1.3, 1.4, 3.3**

### Property 4: Endpoint Format
*For any* claim with name `N` in namespace `NS`, the connection secret's `endpoint` value SHALL equal `{N}-rw.{NS}.svc.cluster.local`.
**Validates: Requirements 2.2**

### Property 5: CNPG Secret Structure
*For any* CNPG Cluster created by the composition, the auto-generated `-app` secret SHALL contain keys: `username`, `password`, `dbname`, `host`, and `port`.
**Validates: Requirements 4.2, 4.3**

### Property 6: Credential Source Integrity
*For any* connection secret created by the composition, the `username`, `password`, and `database` values SHALL match the corresponding values in the CNPG-generated `-app` secret.
**Validates: Requirements 2.4, 4.4**

### Property 7: Cleanup on Deletion
*For any* PostgresInstance claim that is deleted, the connection secret specified in `writeConnectionSecretToRef` SHALL be deleted.
**Validates: Requirements 5.3**

## Error Handling

| Error Condition | Handling |
|-----------------|----------|
| CNPG Cluster fails to become ready | Composition remains in non-ready state; claim shows error |
| CNPG `-app` secret not found | Object provider retries; connection-secret resource not ready |
| Invalid claim name (special chars) | XRD validation rejects claim |
| Namespace doesn't exist | Kubernetes rejects claim creation |

## Testing Strategy

### Unit Tests
- XRD schema validation (required fields, defaults, enums)
- Name transformation logic (hyphen to underscore)
- Endpoint format generation

### Property-Based Tests

The following property-based tests will be implemented using a suitable PBT library for YAML/Kubernetes manifests:

1. **Property 1 Test:** Generate random claim names, verify CNPG manifest has no `initdb.secret`
2. **Property 3 Test:** Generate claim names with various hyphen patterns, verify transformation
3. **Property 4 Test:** Generate claim name/namespace pairs, verify endpoint format
4. **Property 6 Test:** Create claims, verify credential values match between secrets

### Integration Tests
- End-to-end claim creation → secret availability
- Application deployment using connection secret
- Claim deletion → secret cleanup

### Test Framework
- Property-based testing: **fast-check** (if TypeScript tooling available) or manual YAML generation with shell scripts
- Integration testing: kubectl + shell scripts against test cluster
